# Apple Sign-In Debug Checklist

## Current Status
You've configured Apple Sign-In multiple times but still getting "Invalid client id or web redirect url" error.

## Let's Debug Systematically

### Step 1: Verify Apple Developer Console Configuration

#### A. Check Services ID
1. Go to: https://developer.apple.com/account/resources/identifiers/list/serviceId
2. Find your Services ID: `com.youi.supabase`
3. Click on it
4. **Verify:**
   - [ ] "Sign in with Apple" is **checked**
   - [ ] Click "Configure" next to "Sign in with Apple"
   - [ ] In the "Domains and Subdomains" section, you should see: `empmaiqjpyhanrpuabou.supabase.co`
   - [ ] In the "Return URLs" section, you should see: `https://empmaiqjpyhanrpuabou.supabase.co/auth/v1/callback`
   - [ ] **EXACT URL**: Make sure it's exactly `https://empmaiqjpyhanrpuabou.supabase.co/auth/v1/callback` (not `/auth/v1/authorize`)

#### B. Check Signing Key
1. Go to: https://developer.apple.com/account/resources/authkeys/list
2. Find your key (should show Key ID: `M2C99U6Z38`)
3. **Verify:**
   - [ ] "Sign in with Apple" is enabled for this key
   - [ ] You have the `.p8` file downloaded and saved

### Step 2: Verify Supabase Configuration

#### Go to: https://supabase.com/dashboard/project/empmaiqjpyhanrpuabou/auth/providers

1. Find "Apple" in the providers list
2. Click on it
3. **Check these EXACT values:**

```
Enabled: [Toggle should be ON/Green]

Services ID (Client ID): com.youi.supabase
(Must match exactly what's in Apple Developer Console)

Secret Key: eyJ... (long JWT token, starts with "eyJ")
(This should be the JWT generated by Supabase's tool, NOT the raw .p8 file)

Key ID: M2C99U6Z38
(Must match the Key ID from Apple Developer Console)

Team ID: RX9FNDKHNY
(Must match your Apple Team ID)
```

### Step 3: Common Issues

#### Issue 1: Secret Key is Wrong
**Problem:** The Secret Key field contains:
- The raw `.p8` file contents (starts with `-----BEGIN PRIVATE KEY-----`)
- An old/expired JWT
- Nothing (empty)

**Solution:**
1. Go to: https://supabase.com/docs/guides/auth/social-login/auth-apple
2. Scroll to "Generate Apple Client Secret" tool
3. Use **Firefox or Chrome** (not Safari)
4. Fill in:
   - Account ID: `RX9FNDKHNY`
   - Service ID: `com.youi.supabase`
   - Key ID: `M2C99U6Z38`
   - Private Key: (paste ENTIRE `.p8` file contents including BEGIN/END lines)
5. Click "Generate Secret Key"
6. Copy the generated JWT (starts with `eyJ`)
7. Paste it into Supabase's "Secret Key" field

#### Issue 2: Services ID Mismatch
**Problem:** The Services ID in Supabase doesn't match Apple Developer Console

**Check:**
- Apple Developer Console Services ID: `com.youi.supabase`
- Supabase Services ID field: Must be exactly `com.youi.supabase`
- They must match character-for-character

#### Issue 3: Wrong Redirect URL in Apple
**Problem:** The redirect URL in Apple Developer Console is wrong

**Must be:**
- ✅ `https://empmaiqjpyhanrpuabou.supabase.co/auth/v1/callback`

**NOT:**
- ❌ `youi://auth` (this is your app's deep link, not Apple's redirect)
- ❌ `https://empmaiqjpyhanrpuabou.supabase.co/auth/v1/authorize` (wrong endpoint)
- ❌ Any other URL

#### Issue 4: Provider Not Enabled
**Problem:** The Apple provider toggle is OFF in Supabase

**Solution:** Make sure the toggle is ON (green) in Supabase

### Step 4: Test with Detailed Logging

After verifying all the above, try Apple Sign-In and check the logs:

```
LOG  === APPLE OAUTH DEBUG START ===
LOG  Auth redirectUrl (Apple): youi://auth
LOG  Supabase URL: https://empmaiqjpyhanrpuabou.supabase.co
LOG  Starting Apple OAuth with redirectUrl: youi://auth
LOG  OAuth response data: {"provider": "apple", "url": "..."}
LOG  Opening Apple auth URL: ...
LOG  Opening WebBrowser session...
```

After dismissing the error page, you should see:
```
LOG  WebBrowser session returned: [timestamp]
LOG  WebBrowser result: {...}
LOG  Auth session result type (Apple): cancel (or dismiss)
```

### Step 5: Screenshot Verification

To help debug, please take screenshots of:

1. **Apple Developer Console - Services ID Configuration**
   - Show the "Sign in with Apple" configuration page
   - Show the Domains and Return URLs

2. **Supabase Dashboard - Apple Provider**
   - Show all 4 fields (Services ID, Secret Key, Key ID, Team ID)
   - Show that the toggle is ON
   - You can blur/hide the Secret Key for security

3. **Console logs**
   - Show the complete logs from `=== APPLE OAUTH DEBUG START ===` to the end

### Step 6: Alternative Approach - Check Supabase Logs

1. Go to: https://supabase.com/dashboard/project/empmaiqjpyhanrpuabou/logs/explorer
2. Look for any errors related to Apple OAuth
3. This might show server-side errors that aren't visible in your app

### Step 7: Verify the Generated Secret Key

The secret key (JWT) should:
- Start with `eyJ`
- Be very long (several hundred characters)
- Look like: `eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Ik0yQzk5VTZaMzgifQ.eyJpc3MiOiJSWDlGTkRLSE5ZIiwiaWF0IjoxNzMxNjc4...`
- Be valid for 6 months from generation

If your secret key looks different, regenerate it.

## Quick Verification Commands

### What to check RIGHT NOW:

1. **In Supabase Dashboard:**
   - [ ] Apple provider toggle is ON (green)
   - [ ] Services ID field = `com.youi.supabase`
   - [ ] Secret Key starts with `eyJ` (not `-----BEGIN`)
   - [ ] Key ID = `M2C99U6Z38`
   - [ ] Team ID = `RX9FNDKHNY`

2. **In Apple Developer Console:**
   - [ ] Services ID `com.youi.supabase` exists
   - [ ] "Sign in with Apple" is checked
   - [ ] Return URL = `https://empmaiqjpyhanrpuabou.supabase.co/auth/v1/callback` (exactly)

3. **Test:**
   - [ ] Restart Expo dev server
   - [ ] Try Apple Sign-In
   - [ ] Share the complete logs

## If Still Not Working

If you've verified ALL of the above and it still doesn't work, the issue might be:

1. **Caching**: Supabase might be caching old configuration
   - Try waiting 5-10 minutes after saving configuration
   - Try clearing your browser cache
   - Try in an incognito/private browser window

2. **Secret Key Expired**: If you generated the secret key more than 6 months ago
   - Generate a new one
   - Update Supabase

3. **Apple Developer Account Issues**: 
   - Make sure your Apple Developer account is active
   - Make sure you have the right permissions

## Next Steps

Please verify each checkbox above and let me know:
1. Which checkboxes are ✅ (working)
2. Which checkboxes are ❌ (not working or different)
3. Share screenshots if possible
4. Share the complete console logs after trying Apple Sign-In

This will help identify the exact issue.


